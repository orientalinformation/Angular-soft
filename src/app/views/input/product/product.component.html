<div class="container" *ngIf="!isLoading">
  <app-chaining #chainingControls (loaded)="onChainControlsLoaded()" *ngIf="study.CHAINING_CONTROLS"></app-chaining>

  <div class="card-group product-container mb-3">
    <div class="card">
      <div class="card-header">
        <strong>{{ 'PRODUCT DEFINITION' | translate }}</strong>
        <button type="button" class="btn btn-sm btn-primary float-right" [disabled]="study.CHAINING_CONTROLS && (study.HAS_CHILD || study.PARENT_ID != 0)" (click)="modalEditProduct.show()" *ngIf="productShape != 0">
          <i class="fa fa-pencil-square-o"></i> {{'EDIT'|translate}}
        </button>
      </div>
      <div class="card-body" *ngIf="productShape !== 0">
        <div class="row">
          <div class="col-md-12">
            <div class="container">
              <!-- product name -->
              <div class="row">
                <div class="col-md-5">{{ 'Product name'|translate }}</div>
                <div class="col-md-7">{{ product.PRODNAME }}</div>
              </div>
              <!-- product shape -->
              <div class="row">
                <div class="col-md-5">{{ 'Shape'|translate }}</div>
                <div class="col-md-7">{{ 'SHAPECODE_'+productShape | translate }}</div>
              </div>
              <!-- dimension 1 -->
              <div class="row" *ngIf="productShape != shapeNames.SLAB && productShape != shapeNames.SPHERE">
                <div class="col-md-5">
                  <label *ngIf="productShape == shapeNames.REC_STAND || productShape == shapeNames.BREAD">{{'Length'|translate}}</label>
                  <label *ngIf="productShape == shapeNames.CYL_LAY || productShape == shapeNames.CYL_STAND">{{'Diameter'|translate}}</label>
                  <label *ngIf="productShape == shapeNames.REC_LAY || productShape == shapeNames.CON_CYL_STAND
                                    || productShape == shapeNames.CON_CYL_LAY">{{'Height'|translate}}</label>
                </div>
                <div class="col-md-7" *ngIf="symbol">{{prodDim1}} {{symbol.prodDimensionSymbol}}</div>
              </div>
              <!-- dimension 3 -->
              <div class="row" *ngIf="(productShape == shapeNames.REC_STAND || productShape == shapeNames.REC_LAY || productShape == shapeNames.BREAD)">
                <div class="col-md-5">{{'Width'|translate}}</div>
                <div class="col-md-7" *ngIf="symbol">{{prodDim3}} {{symbol.prodDimensionSymbol}}</div>
              </div>
              <!-- variable dimension -->
              <div class="row">
                <div class="col-md-5">
                  <strong>
                    <label *ngIf="productShape == shapeNames.REC_STAND || productShape == shapeNames.BREAD 
                      || productShape == shapeNames.CYL_STAND">{{'Height'|translate}}</label>
                    <label *ngIf="productShape == shapeNames.SLAB">{{'Thickness'|translate}}</label>
                    <label *ngIf="productShape == shapeNames.REC_LAY || productShape == shapeNames.CYL_LAY">{{'Length'|translate}}</label>
                    <label *ngIf="productShape == shapeNames.SPHERE || productShape == shapeNames.CON_CYL_STAND
                      || productShape == shapeNames.CON_CYL_LAY">{{'Diameter'|translate}}</label>
                  </strong>
                </div>
                <div class="col-md-7" *ngIf="symbol">{{prodDim2}} {{symbol.prodDimensionSymbol}}</div>
              </div>
            </div> <!-- /.container -->
            <div class="container border mt-3">
              <div class="row">
                <div class="col-md-5">{{'Calculated mass'|translate}}</div>
                <div class="col-md-7">{{product.PROD_WEIGHT}} {{symbol.massSymbol}}</div>
              </div>
              <div class="row">
                <div class="col-md-5"><strong>{{'Real mass/unit'|translate}}</strong></div>
                <div class="col-md-7">{{product.PROD_REALWEIGHT}} {{symbol.massSymbol}}</div>
              </div>
            </div>
          </div><!-- /col-md-10 -->
        </div>
      </div> <!-- /.card-body -->    
      <div *ngIf="productShape === 0" class="text-center card-body">
        <button class="btn btn-primary btn-lg" (click)="modalEditProduct.show()">{{'DEFINE'|translate}}</button>
      </div><!-- /.card-body -->
    </div> <!-- /.card -->

    <div class="card">
      <div class="card-header">
        <strong>{{ '3D VIEW' | translate }}</strong>
        <button type="button" class="btn btn-sm btn-primary float-right">
          <i class="fa fa-refresh"></i>
        </button>
      </div>
      <div class="card-body">

      </div><!-- /.card-body -->
    </div><!-- /.card -->
  </div>
  
  <div class="card">
    <div class="card-header">
      <strong>{{'PRODUCT ELEMENTS'|translate}}</strong>
      <div class="float-right">
        <button type="button" class="btn btn-success btn-sm" 
          [disabled]="study.CHAINING_CONTROLS && (study.HAS_CHILD || !study.CHAINING_ADD_COMP_ENABLE)"
          data-style="slide-left" [ladda]="laddaAddComponent" (click)="onShowAddElement()">
          <i class="fa fa-plus"></i> {{'ADD'|translate}}
        </button>
      </div>
    </div>
    <table class="table table-sm table-bordered table-hover mb-0" *ngIf="elements.length > 0">
      <thead>
        <tr *ngIf="symbol">
          <th class="text-center" width="2%"><i class="fa fa-sort" aria-hidden="true"></i></th>
          <th class="text-center">{{'Component name'|translate}}</th>
          <th class="text-center">{{'Description'|translate}}</th>
          <th class="text-center">{{'Specific Dim.'|translate}} ({{symbol.prodDimensionSymbol}})</th>
          <th class="text-center">{{'Calculated Mass'|translate}} ({{symbol.massSymbol}})</th>
          <th class="text-center">{{'Real mass'|translate}} ({{symbol.massSymbol}})</th>
          <th class="text-center" width="1%">{{'Actions'|translate}}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let element of elements; first as isFirst; last as isLast; let i = index">
          <td class="text-center nowrap">
            <a *ngIf="!isFirst" (click)="onMoveUpElement(element)"><i class="fa fa-caret-up" aria-hidden="true"></i></a><a *ngIf="!isLast" (click)="onMoveDownElement(element)"><i class="fa fa-caret-down" aria-hidden="true"></i></a>
          </td>
          <td> <i class="fa fa-stop fa-lg" [style.color]="prodColors[i].CODE_HEXA"></i> {{'components.'+element.ID_COMP|translate}}</td>
          <td class="text-center">
            {{ element.PROD_ELMT_NAME }}
            <div *ngIf="study.CHAINING_CONTROLS && study.PARENT_ID != 0 && element.INSERT_LINE_ORDER != study.ID_STUDY">
              {{'(parent component)'|translate}}
            </div>
          </td>
          <td class="text-center">{{ element.SHAPE_PARAM2 }}</td>
          <td class="text-center">{{ element.PROD_ELMT_WEIGHT }}</td>
          <td class="text-center">{{ element.PROD_ELMT_REALWEIGHT }}</td>
          <td class="text-center nowrap">
            <button class="btn btn-sm btn-primary" 
              (click)="onEditElement(element)" 
              [disabled]="study.HAS_CHILD || element.INSERT_LINE_ORDER != study.ID_STUDY">
                <i class="fa fa-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" 
              (click)="onRemoveElement(element, i)" 
              [disabled]="study.HAS_CHILD ||element.INSERT_LINE_ORDER != study.ID_STUDY" [ladda]="laddaDeletingElmts[i]">
              <i class="fa fa-minus-circle"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="card-body text-center text-muted" *ngIf="elements.length == 0">
      <p>{{'No data to display'|translate}}</p>
    </div>
  </div>
  
</div>

<div bsModal class="modal fade" #modalEditProduct="bs-modal" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <strong>{{'EDIT PRODUCT'|translate}}</strong>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="modalEditProduct.hide()">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body row">
        <div class="col-md-4 align-self-center">
          <img *ngIf="previewImgSrc" [src]="previewImgSrc" class="img-fluid mx-auto d-block">
        </div>
        <div class="col-md-8">
          <div class="form-group row">
            <label class="col-md-3 col-form-label" for="text-input">Product name</label>
            <div class="col-md-9">
              <input type="text" id="text-input" name="text-input" class="form-control" [(ngModel)]="productForm.name">
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label" for="email-input">Product shape</label>
            <div class="col-md-9">
              <select [(ngModel)]="productForm.shape" class="form-control" (ngModelChange)="onChangeShape()" >
                <option *ngFor="let shape of availShapes" [value]="shape.ID_SHAPE">{{ 'SHAPECODE_'+shape.SHAPECODE | translate }}</option>
              </select>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label" for="email-input">Dimension 1</label>
            <div class="col-md-9">
              <div class="input-group">
                <input type="text" name="dim1" class="form-control" [(ngModel)]="productForm.dim1" [disabled]="productForm.shape == 0 || productForm.shape == shapeNames.SLAB || productForm.shape == shapeNames.SPHERE">
                <span class="input-group-addon" *ngIf="symbol">{{symbol.prodDimensionSymbol}}</span>
              </div>              
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label" for="email-input">Dimension 2</label>
            <div class="col-md-9">
              <div class="input-group">
                <input type="text" name="dim1" class="form-control" [(ngModel)]="productForm.dim2" [disabled]="productForm.shape == 0 || productForm.shape == shapeNames.SLAB || productForm.shape == shapeNames.SPHERE || 
                                (productForm.shape == shapeNames.REC_STAND) || (productForm.shape == shapeNames.REC_LAY) || (productForm.shape == shapeNames.BREAD) ||
                                (productForm.shape == shapeNames.CYL_STAND) || (productForm.shape == shapeNames.CYL_LAY) || (productForm.shape == shapeNames.CON_CYL_STAND) ||
                                (productForm.shape == shapeNames.CON_CYL_LAY)">
                <span class="input-group-addon" *ngIf="symbol">{{symbol.prodDimensionSymbol}}</span>
              </div>              
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label" for="email-input">Dimension 3</label>
            <div class="col-md-9">
              <div class="input-group">
                <input type="text" name="dim1" class="form-control" [(ngModel)]="productForm.dim3" [disabled]="productForm.shape == 0 || productForm.shape == shapeNames.SLAB || productForm.shape == shapeNames.SPHERE || (productForm.shape == shapeNames.CYL_STAND) || (productForm.shape
                                == shapeNames.CYL_LAY) || (productForm.shape == shapeNames.CON_CYL_STAND) || (productForm.shape == shapeNames.CON_CYL_LAY)">
                <span class="input-group-addon" *ngIf="symbol">{{symbol.prodDimensionSymbol}}</span>
              </div>
              
            </div>
          </div>
        </div>
      </div><!-- modal-body -->
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal" (click)="modalEditProduct.hide()">Cancel</button>
        <button class="btn btn-primary" (click)="saveProduct()">Save changes</button>
      </div>
    </div>
  </div>
</div>

<div bsModal class="modal fade" #addElementModal="bs-modal" role="dialog" aria-hidden="true" (onShow)="onEditProductModalShow('onShow', $event)">
  <div class="modal-dialog" role="document" style="max-width:70%;">
    <div class="modal-content">
      <div class="modal-header">
        <strong>{{'ADDING COMPONENTS'|translate}}</strong>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="addElementModal.hide()">
          <span aria-hidden="true">×</span>
        </button>
      </div>

      <div class="modal-body">
        <p>
          Enter from bottom to top (vertical), left to right (horizontal), core to surface (concentric)
        </p>
          <div class="card-group">
            <div class="card">
              <div class="card-header">Filter</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-5">
                    <p>{{'Component family'|translate}}</p>
                  </div>
                  <div class="col-md-7">
                    <ng-select class="bootstrap" [allowClear]="true" name="compfamily"></ng-select>
                  </div>
                </div>
                <br>
                <div class="row">
                  <div class="col-md-5">
                    <p>{{'Sub family'|translate}}</p>
                  </div>
                  <div class="col-md-7">
                    <ng-select class="bootstrap" [allowClear]="true" name="subfamily"></ng-select>
                  </div>
                </div>
                <br>
                <div class="row">
                  <div class="col-md-5">
                    <p>{{'Water percenttage'|translate}}</p>
                  </div>
                  <div class="col-md-7">
                    <ng-select class="bootstrap" [allowClear]="true" name="waterpercent"></ng-select>
                  </div>
                </div>
              </div>
            </div>
          
            <div class="card" *ngIf="components">
              <div class="card-header">
                &nbsp;
                <div>
                  <div class="input-group input-group-sm" id="components-search-box">
                    <input type="text" class="form-control" [(ngModel)]="filterString" placeholder="{{'Search'|translate}}" />
                    <span>
                      <i class="fa fa-search" aria-hidden="true"></i>
                    </span>
                  </div>
                </div>
              </div>
              <div class="list-group">
                <perfect-scrollbar style="max-height: 250px">
                  <div class="list-group">
                    <a *ngFor="let component of (components.active | compFilter: filterString)" class="list-group-item list-group-item-action" 
                      style="height:30px; padding: 5px 10px;"  [ngClass]="component == selectedAddingElement? 'active' : ''" 
                      (click)="onSelectAddingElement(component)">
                      <p>{{ 'components.' + component.ID_COMP.toString() | translate }} - {{component.COMP_VERSION}}</p>
                    </a>
                    <h6 class="dropdown-header text-center" *ngIf="components.sleeping">{{'--------------- SLEEPING COMPONENTS ---------------'|translate}}</h6>
                    <a *ngFor="let component of (components.sleeping | compFilter: filterString)" class="list-group-item list-group-item-action" style="height:30px; padding: 5px 10px;"
                      [ngClass]="component == selectedAddingElement? 'active' : ''" (click)="onSelectAddingElement(component)">
                      <p>{{'SCD:'|translate}} {{ 'components.' + component.ID_COMP.toString() | translate }} - {{component.COMP_VERSION}}</p>
                    </a>
                  </div>
                </perfect-scrollbar>
              </div>
            </div>
          </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal" (click)="addElementModal.hide()">{{'Cancel'|translate}}</button>
        <button class="btn btn-primary" (click)="onAddElement()" [ladda]="laddaConfirmAddComponent">{{'Confirm'|translate}}</button>
      </div>
    </div>
  </div>
</div>


<div bsModal class="modal fade" #editCompModal="bs-modal" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <strong>{{'Product Component'|translate}}</strong>
        <button class="close" arria-label="Close" data-dismiss="modal" (click)="editCompModal.hide()">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <form class="form-horizontal">
          <div class="form-group row">
            <div class="col-md-4" style="float:right">{{'Description:'|translate}}</div>
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" name="description" class="form-control" [(ngModel)]="elementForm.description">
              </div>
            </div>
          </div>
          <div class="form-group row">
            <div class="col-md-4" style="float:right">{{'Specific Dim.:'|translate}}</div>
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" name="specificDim" class="form-control" [(ngModel)]="elementForm.specific_dim">
                <span class="input-group-addon" *ngIf="symbol">{{symbol.prodDimensionSymbol}}</span>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <div class="col-md-4" style="float:right">{{'Calculated mass:'|translate}}</div>
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" name="calcMass" class="form-control" disabled [(ngModel)]="elementForm.computed_mass">
                <span class="input-group-addon" *ngIf="symbol">{{symbol.massSymbol}}</span>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <div class="col-md-4" style="float:right">{{'Real mass:'|translate}}</div>
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" name="realMass" class="form-control" [(ngModel)]="elementForm.real_mass">
                <span class="input-group-addon" *ngIf="symbol">{{symbol.massSymbol}}</span>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" (click)="editCompModal.hide()">{{'Cancel'|translate}}</button>
        <button class="btn btn-primary btn-sm" (click)="updateProductElement()" [ladda]="laddaUpdateElement">{{'Update'|translate}}</button>
      </div>
    </div>
  </div>
</div>

<app-spinner *ngIf="isLoading"></app-spinner>